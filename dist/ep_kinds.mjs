const ep_proto$1 = Object.create(Object.getPrototypeOf(function () {}));
function add_ep_kind(kinds) {
  Object.assign(ep_proto$1, kinds);
}

add_ep_kind({
  clientEndpoint(api) {
    const target = clientEndpoint(api);
    this.endpoint(target);
    return target.done;
  },

  client(...args) {
    if (1 === args.length && 'function' === typeof args[0]) {
      return this.clientEndpoint(args[0]);
    }

    const msg_ctx = new this.MsgCtx();
    return 0 !== args.length ? msg_ctx.to(...args) : msg_ctx;
  } });

const ep_client_api = {
  async on_ready(ep, hub) {
    this._resolve((await this.on_client_ready(ep, hub)));
    await ep.shutdown();
  },
  on_send_error(ep, err) {
    this._reject(err);
  },
  on_shutdown(ep, err) {
    err ? this._reject(err) : this._resolve();
  } };

function clientEndpoint(on_client_ready) {
  let target = Object.create(ep_client_api);
  target.on_client_ready = on_client_ready;
  target.done = new Promise((resolve, reject) => {
    target._resolve = resolve;
    target._reject = reject;
  });
  return target;
}

add_ep_kind({
  api(api) {
    return this.endpoint(asAPIEndpoint(api));
  } });

function asAPIEndpoint(api) {
  return (ep, hub) => {
    const invoke = as_rpc(api, ep, hub);
    return on_msg;

    async function on_msg({ msg, sender }) {
      await invoke(msg, sender);
    }
  };
}

function as_rpc(api, ep, hub) {
  const api_for_op = 'function' === typeof api ? op => api(op, ep, hub) : op => api[op];

  return Object.assign(invoke, {
    invoke, resolve_fn, invoke_fn, api_for_op });

  async function invoke(msg, sender) {
    const { op, kw } = msg;
    const fn = await resolve_fn(op, sender);
    if (undefined !== fn) {
      await invoke_fn(op, sender, () => fn(kw));
    }
  }

  async function resolve_fn(op, sender) {
    if ('string' !== typeof op || !op[0].match(/[A-Za-z]/)) {
      await sender.send({ op, err_from: ep,
        error: { message: 'Invalid operation', code: 400 } });
    }

    try {
      const fn = await api_for_op(op);
      if (!fn) {
        await sender.send({ op, err_from: ep,
          error: { message: 'Unknown operation', code: 404 } });
      }
      return fn;
    } catch (err) {
      await sender.send({ op, err_from: ep,
        error: { message: `Invalid operation: ${err.message}`, code: 500 } });
    }
  }

  async function invoke_fn(op, sender, cb) {
    try {
      var answer = await cb();
    } catch (err) {
      await sender.send({ op, err_from: ep, error: err });
      return false;
    }

    if (sender.replyExpected) {
      await sender.send({ op, answer });
    }
    return true;
  }
}

add_ep_kind({
  server(on_init) {
    return this.endpoint(on_init);
  } });

export { clientEndpoint, asAPIEndpoint, as_rpc };
export default ep_proto$1;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXBfa2luZHMubWpzIiwic291cmNlcyI6WyIuLi9jb2RlL2VwX2tpbmRzL2V4dGVuc2lvbnMuanN5IiwiLi4vY29kZS9lcF9raW5kcy9jbGllbnQuanN5IiwiLi4vY29kZS9lcF9raW5kcy9hcGkuanN5IiwiLi4vY29kZS9lcF9raW5kcy9pbmRleC5qc3kiXSwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNvbnN0IGVwX3Byb3RvID0gT2JqZWN0LmNyZWF0ZSBAIE9iamVjdC5nZXRQcm90b3R5cGVPZiBAIGZ1bmN0aW9uKCl7fVxuZXhwb3J0IGZ1bmN0aW9uIGFkZF9lcF9raW5kKGtpbmRzKSA6OlxuICBPYmplY3QuYXNzaWduIEAgZXBfcHJvdG8sIGtpbmRzXG5leHBvcnQgZGVmYXVsdCBhZGRfZXBfa2luZFxuIiwiaW1wb3J0IGFkZF9lcF9raW5kIGZyb20gJy4vZXh0ZW5zaW9ucy5qc3knXG5cbmFkZF9lcF9raW5kIEA6XG4gIGNsaWVudEVuZHBvaW50KGFwaSkgOjpcbiAgICBjb25zdCB0YXJnZXQgPSBjbGllbnRFbmRwb2ludChhcGkpXG4gICAgdGhpcy5lbmRwb2ludCBAIHRhcmdldFxuICAgIHJldHVybiB0YXJnZXQuZG9uZVxuXG4gIGNsaWVudCguLi5hcmdzKSA6OlxuICAgIGlmIDEgPT09IGFyZ3MubGVuZ3RoICYmICdmdW5jdGlvbicgPT09IHR5cGVvZiBhcmdzWzBdIDo6XG4gICAgICByZXR1cm4gdGhpcy5jbGllbnRFbmRwb2ludCBAIGFyZ3NbMF1cblxuICAgIGNvbnN0IG1zZ19jdHggPSBuZXcgdGhpcy5Nc2dDdHgoKVxuICAgIHJldHVybiAwICE9PSBhcmdzLmxlbmd0aCA/IG1zZ19jdHgudG8oLi4uYXJncykgOiBtc2dfY3R4XG5cblxuY29uc3QgZXBfY2xpZW50X2FwaSA9IEB7fVxuICBhc3luYyBvbl9yZWFkeShlcCwgaHViKSA6OlxuICAgIHRoaXMuX3Jlc29sdmUgQCBhd2FpdCB0aGlzLm9uX2NsaWVudF9yZWFkeShlcCwgaHViKVxuICAgIGF3YWl0IGVwLnNodXRkb3duKClcbiAgb25fc2VuZF9lcnJvcihlcCwgZXJyKSA6OlxuICAgIHRoaXMuX3JlamVjdChlcnIpXG4gIG9uX3NodXRkb3duKGVwLCBlcnIpIDo6XG4gICAgZXJyID8gdGhpcy5fcmVqZWN0KGVycikgOiB0aGlzLl9yZXNvbHZlKClcblxuZXhwb3J0IGZ1bmN0aW9uIGNsaWVudEVuZHBvaW50KG9uX2NsaWVudF9yZWFkeSkgOjpcbiAgbGV0IHRhcmdldCA9IE9iamVjdC5jcmVhdGUgQCBlcF9jbGllbnRfYXBpXG4gIHRhcmdldC5vbl9jbGllbnRfcmVhZHkgPSBvbl9jbGllbnRfcmVhZHlcbiAgdGFyZ2V0LmRvbmUgPSBuZXcgUHJvbWlzZSBAIChyZXNvbHZlLCByZWplY3QpID0+IDo6XG4gICAgdGFyZ2V0Ll9yZXNvbHZlID0gcmVzb2x2ZVxuICAgIHRhcmdldC5fcmVqZWN0ID0gcmVqZWN0XG4gIHJldHVybiB0YXJnZXRcbiIsImltcG9ydCBhZGRfZXBfa2luZCBmcm9tICcuL2V4dGVuc2lvbnMuanN5J1xuXG5hZGRfZXBfa2luZCBAOlxuICBhcGkoYXBpKSA6OiByZXR1cm4gdGhpcy5lbmRwb2ludCBAIGFzQVBJRW5kcG9pbnQoYXBpKVxuXG5leHBvcnQgZnVuY3Rpb24gYXNBUElFbmRwb2ludChhcGkpIDo6XG4gIHJldHVybiAoZXAsIGh1YikgPT4gOjpcbiAgICBjb25zdCBpbnZva2UgPSBhc19ycGMoYXBpLCBlcCwgaHViKVxuICAgIHJldHVybiBvbl9tc2dcblxuICAgIGFzeW5jIGZ1bmN0aW9uIG9uX21zZyh7bXNnLCBzZW5kZXJ9KSA6OlxuICAgICAgYXdhaXQgaW52b2tlIEAgbXNnLCBzZW5kZXJcblxuZXhwb3J0IGZ1bmN0aW9uIGFzX3JwYyhhcGksIGVwLCBodWIpIDo6XG4gIGNvbnN0IGFwaV9mb3Jfb3AgPSAnZnVuY3Rpb24nID09PSB0eXBlb2YgYXBpXG4gICAgPyBvcCA9PiBhcGkob3AsIGVwLCBodWIpXG4gICAgOiBvcCA9PiBhcGlbb3BdXG5cbiAgcmV0dXJuIE9iamVjdC5hc3NpZ24gQCBpbnZva2UsIEB7fVxuICAgIGludm9rZSwgcmVzb2x2ZV9mbiwgaW52b2tlX2ZuLCBhcGlfZm9yX29wXG5cbiAgYXN5bmMgZnVuY3Rpb24gaW52b2tlKG1zZywgc2VuZGVyKSA6OlxuICAgIGNvbnN0IHtvcCwga3d9ID0gbXNnXG4gICAgY29uc3QgZm4gPSBhd2FpdCByZXNvbHZlX2ZuIEAgb3AsIHNlbmRlclxuICAgIGlmIHVuZGVmaW5lZCAhPT0gZm4gOjpcbiAgICAgIGF3YWl0IGludm9rZV9mbiBAIG9wLCBzZW5kZXIsICgpID0+IGZuKGt3KVxuXG4gIGFzeW5jIGZ1bmN0aW9uIHJlc29sdmVfZm4ob3AsIHNlbmRlcikgOjpcbiAgICBpZiAnc3RyaW5nJyAhPT0gdHlwZW9mIG9wIHx8ICEgb3BbMF0ubWF0Y2goL1tBLVphLXpdLykgOjpcbiAgICAgIGF3YWl0IHNlbmRlci5zZW5kIEA6IG9wLCBlcnJfZnJvbTogZXBcbiAgICAgICAgZXJyb3I6IEB7fSBtZXNzYWdlOiAnSW52YWxpZCBvcGVyYXRpb24nLCBjb2RlOiA0MDBcblxuICAgIHRyeSA6OlxuICAgICAgY29uc3QgZm4gPSBhd2FpdCBhcGlfZm9yX29wKG9wKVxuICAgICAgaWYgISBmbiA6OlxuICAgICAgICBhd2FpdCBzZW5kZXIuc2VuZCBAOiBvcCwgZXJyX2Zyb206IGVwXG4gICAgICAgICAgZXJyb3I6IEB7fSBtZXNzYWdlOiAnVW5rbm93biBvcGVyYXRpb24nLCBjb2RlOiA0MDRcbiAgICAgIHJldHVybiBmblxuICAgIGNhdGNoIGVyciA6OlxuICAgICAgYXdhaXQgc2VuZGVyLnNlbmQgQDogb3AsIGVycl9mcm9tOiBlcFxuICAgICAgICBlcnJvcjogQHt9IG1lc3NhZ2U6IGBJbnZhbGlkIG9wZXJhdGlvbjogJHtlcnIubWVzc2FnZX1gLCBjb2RlOiA1MDBcblxuICBhc3luYyBmdW5jdGlvbiBpbnZva2VfZm4ob3AsIHNlbmRlciwgY2IpIDo6XG4gICAgdHJ5IDo6XG4gICAgICB2YXIgYW5zd2VyID0gYXdhaXQgY2IoKVxuICAgIGNhdGNoIGVyciA6OlxuICAgICAgYXdhaXQgc2VuZGVyLnNlbmQgQDogb3AsIGVycl9mcm9tOiBlcCwgZXJyb3I6IGVyclxuICAgICAgcmV0dXJuIGZhbHNlXG5cbiAgICBpZiBzZW5kZXIucmVwbHlFeHBlY3RlZCA6OlxuICAgICAgYXdhaXQgc2VuZGVyLnNlbmQgQDogb3AsIGFuc3dlclxuICAgIHJldHVybiB0cnVlXG5cbiIsImltcG9ydCB7YWRkX2VwX2tpbmQsIGVwX3Byb3RvfSBmcm9tICcuL2V4dGVuc2lvbnMuanN5J1xuXG5hZGRfZXBfa2luZCBAOlxuICBzZXJ2ZXIob25faW5pdCkgOjogcmV0dXJuIHRoaXMuZW5kcG9pbnQgQCBvbl9pbml0XG5cbmV4cG9ydCAqIGZyb20gJy4vY2xpZW50LmpzeSdcbmV4cG9ydCAqIGZyb20gJy4vYXBpLmpzeSdcblxuZXhwb3J0IGRlZmF1bHQgZXBfcHJvdG9cbiJdLCJuYW1lcyI6WyJlcF9wcm90byIsIk9iamVjdCIsImNyZWF0ZSIsImdldFByb3RvdHlwZU9mIiwiYWRkX2VwX2tpbmQiLCJraW5kcyIsImFzc2lnbiIsImFwaSIsInRhcmdldCIsImNsaWVudEVuZHBvaW50IiwiZW5kcG9pbnQiLCJkb25lIiwiYXJncyIsImxlbmd0aCIsIm1zZ19jdHgiLCJNc2dDdHgiLCJ0byIsImVwX2NsaWVudF9hcGkiLCJvbl9yZWFkeSIsImVwIiwiaHViIiwiX3Jlc29sdmUiLCJvbl9jbGllbnRfcmVhZHkiLCJzaHV0ZG93biIsImVyciIsIl9yZWplY3QiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImFzQVBJRW5kcG9pbnQiLCJpbnZva2UiLCJhc19ycGMiLCJvbl9tc2ciLCJtc2ciLCJzZW5kZXIiLCJhcGlfZm9yX29wIiwib3AiLCJyZXNvbHZlX2ZuIiwiaW52b2tlX2ZuIiwia3ciLCJmbiIsInVuZGVmaW5lZCIsIm1hdGNoIiwic2VuZCIsImVycl9mcm9tIiwibWVzc2FnZSIsImNvZGUiLCJjYiIsImFu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
