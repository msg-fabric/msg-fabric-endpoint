
export default function(packetParser) ::
  const {concatBuffers, unpack_utf8} = packetParser

  return @:
    trailerAsJSON
    createMultipart

  function trailerAsJSON(pkt) ::
    const trailer = pkt.unpack_utf8 @ pkt.trailer
    pkt.trailer = JSON.parse @ trailer

  function createMultipart(msgid, sink) ::
    let parts = [], last = false

    return function feed(seq, body_buf) ::
      if seq < 0 :: last = true; seq = -seq
      parts[seq-1] = body_buf

      if ! parts.includes @ undefined ::
        const res = concatBuffers(parts)
        parts = null
        return res
